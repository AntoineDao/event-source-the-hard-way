# Reconcile Sources

Now that we have a Source CRD defined with Sink and SinkURI fields, we'll need
to use those fields in the Source controller to resolve Sink references and
set the SinkURI in the Source object's status.

## Remove Deployment creation from the Reconcile function

Locate the Reconcile function generated by Kubebuilder. In the reference
project, this is `pkg/controller/samplesource/samplesource_controller.go`.

The generated Reconcile function creates a Deployment owned by the reconciled
resource. Since we don't need to create a deployment for this tutorial, remove this code.

Remove the `kubebuilder:rbac` annotation comments giving the controller
RBAC permissions to manipulate Deployments. Since the controller no longer
creates Deployment objects, it won't need these permissions. These comments are
above the `Reconcile` function declaration.

Remove the second `Watch` call watching Deployments from the `add` function.
Since the source no longer owns Deployment objects, there's no need to watch for
changes to them.

## Enable the Status subresource on the CRD

Before we can update the Status in the controller, we should enable the Status
subresource. This ensures that the controller never updates the Spec or metadata
fields accidentally.

This feature became beta in Kubernetes 1.11, so it might not work properly with
older versions.

## Update Source Status in Reconcile function

The controller's Reconcile function needs to update the reconciled source
object's Status. Add code to the function to preserve the original object, then
compare it with the reconciled object and update the status if a change was
made.

```go
// Create a copy to determine whether the instance has been modified.
original := instance.DeepCopy()

// Reconcile the object. If an error occurred, don't return immediately;
// update the object Status first.
reconcileErr := r.reconcile(ctx, instance)

// Update object Status if necessary. This happens even if the reconcile
// returned an error.
if !equality.Semantic.DeepEqual(original.Status, instance.Status) {
  log.Info("Updating Status", "request", request.NamespacedName)
  // An error may occur here if the object was updated since the last Get.
  // Return the error so the request can be retried later.
  // This call uses the /status subresource to ensure that the object's spec
  // is never updated by the controller.
  if err := r.Status().Update(ctx, instance); err != nil {
    return reconcile.Result{}, err
  }
}

return reconcile.Result{}, reconcileErr
```

You'll need to define the inner `reconcile` function as well.

```go
func (r *ReconcileSampleSource) reconcile(ctx context.Context, instance *sourcesv1alpha1.SampleSource) error {
  return nil
}
```
